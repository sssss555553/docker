# ============================================
# Docker Compose 编排文件 - 电商数据管理系统
# 完整服务编排（15分）
# ============================================
# 评分要点:
# - docker-compose.yml完整规范（3分）
# - 服务依赖关系正确（4分）
# - 自定义网络配置（3分）
# - 服务通信链路完整（3分）
# - 版本兼容性（2分）
# ============================================

services:
  # ==================== 前端服务 - Nginx ====================
  # 负责静态页面服务和API代理
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: ecommerce/frontend:latest
    container_name: ecommerce-frontend
    hostname: frontend
    ports:
      - "8081:80"
    # 服务依赖关系（4分）- 使用condition确保后端健康后再启动
    depends_on:
      backend:
        condition: service_healthy
        restart: true
    networks:
      - ecommerce-network
    restart: unless-stopped
    # 健康检查配置
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    # 资源限制（生产环境最佳实践）
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 后端服务 - Spring Boot ====================
  # RESTful API服务，连接数据库
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: ecommerce/backend:latest
    container_name: ecommerce-backend
    hostname: backend
    ports:
      - "8080:8080"
    # 环境变量管理（重要！2分）- 避免硬编码敏感信息
    environment:
      # 数据库连接配置
      - DB_HOST=database
      - DB_PORT=3306
      - DB_NAME=ecommerce
      - DB_USER=ecommerce_user
      - DB_PASSWORD=ecommerce123
      # 应用配置
      - SHOW_SQL=false
      - LOG_LEVEL=INFO
      - SPRING_PROFILES_ACTIVE=prod
      # JVM优化参数
      - JAVA_OPTS=-XX:MaxRAMPercentage=75 -XX:+UseG1GC -XX:+UseStringDeduplication
    # 服务依赖 - 等待数据库健康后再启动
    depends_on:
      database:
        condition: service_healthy
        restart: true
    networks:
      - ecommerce-network
    restart: unless-stopped
    # 健康检查 - 使用Spring Boot Actuator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==================== 数据库服务 - MySQL ====================
  # 数据持久化存储
  database:
    build:
      context: ./database
      dockerfile: Dockerfile
    image: ecommerce/database:latest
    container_name: ecommerce-database
    hostname: database
    ports:
      - "3306:3306"
    # 环境变量配置
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=ecommerce
      - MYSQL_USER=ecommerce_user
      - MYSQL_PASSWORD=ecommerce123
      - TZ=Asia/Shanghai
    # 数据卷配置（重要！3分）- 确保数据持久化
    volumes:
      # 数据持久化 - 使用命名卷
      - mysql-data:/var/lib/mysql
      # 日志持久化 - 便于问题排查
      - mysql-logs:/var/log/mysql
    networks:
      - ecommerce-network
    restart: unless-stopped
    # 健康检查 - 使用mysqladmin ping
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # MySQL启动参数优化
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=200
      --innodb_buffer_pool_size=256M
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# ==================== 网络配置（5分） ====================
# 自定义bridge网络，实现服务间通信隔离
networks:
  ecommerce-network:
    driver: bridge
    name: ecommerce-network
    # IPAM配置 - 自定义子网
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    # 网络标签
    labels:
      - "com.ecommerce.description=E-Commerce Application Network"
      - "com.ecommerce.environment=production"

# ==================== 数据卷配置 ====================
# 命名卷确保数据持久化和可管理性
volumes:
  # MySQL数据卷
  mysql-data:
    driver: local
    name: ecommerce-mysql-data
    labels:
      - "com.ecommerce.description=MySQL Data Volume"
      - "com.ecommerce.backup=required"
  # MySQL日志卷
  mysql-logs:
    driver: local
    name: ecommerce-mysql-logs
    labels:
      - "com.ecommerce.description=MySQL Logs Volume"
