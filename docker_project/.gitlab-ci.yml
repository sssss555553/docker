# GitLab CI/CD 配置文件 - 电商数据管理系统

stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: ecommerce
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend
  DATABASE_IMAGE: $CI_REGISTRY_IMAGE/database
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/

# ==================== 测试阶段 ====================

unit-test:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  script:
    - echo "执行单元测试..."
    - cd backend
    - mvn clean test
    - mvn jacoco:report
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - backend/target/surefire-reports/
      - backend/target/site/jacoco/
    reports:
      junit: backend/target/surefire-reports/TEST-*.xml
  coverage: '/Total.*?([0-9]{1,3})%/'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

code-quality:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  script:
    - echo "代码质量检查..."
    - cd backend
    - mvn checkstyle:check || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ==================== 构建阶段 ====================

build-backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
  script:
    - echo "构建后端Docker镜像..."
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHA ./backend
    - docker tag $BACKEND_IMAGE:$CI_COMMIT_SHA $BACKEND_IMAGE:latest
    - echo "后端镜像构建完成"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

build-frontend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
  script:
    - echo "构建前端Docker镜像..."
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHA ./frontend
    - docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHA $FRONTEND_IMAGE:latest
    - echo "前端镜像构建完成"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

build-database:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
  script:
    - echo "构建数据库Docker镜像..."
    - docker build -t $DATABASE_IMAGE:$CI_COMMIT_SHA ./database
    - docker tag $DATABASE_IMAGE:$CI_COMMIT_SHA $DATABASE_IMAGE:latest
    - echo "数据库镜像构建完成"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ==================== 推送阶段 ====================

push-images:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "推送镜像到仓库..."
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHA ./backend
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHA ./frontend
    - docker build -t $DATABASE_IMAGE:$CI_COMMIT_SHA ./database
    - docker tag $BACKEND_IMAGE:$CI_COMMIT_SHA $BACKEND_IMAGE:latest
    - docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHA $FRONTEND_IMAGE:latest
    - docker tag $DATABASE_IMAGE:$CI_COMMIT_SHA $DATABASE_IMAGE:latest
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest
    - docker push $DATABASE_IMAGE:$CI_COMMIT_SHA
    - docker push $DATABASE_IMAGE:latest
    - echo "所有镜像推送完成"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ==================== 部署阶段 ====================

deploy-staging:
  stage: deploy
  image: alpine:latest
  script:
    - echo "部署到测试环境..."
    - echo "镜像版本 $CI_COMMIT_SHA"
    - echo "测试环境部署完成"
  environment:
    name: staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual

deploy-production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "部署到生产环境..."
    - echo "镜像版本 $CI_COMMIT_SHA"
    - echo "后端镜像 $BACKEND_IMAGE:$CI_COMMIT_SHA"
    - echo "前端镜像 $FRONTEND_IMAGE:$CI_COMMIT_SHA"
    - echo "数据库镜像 $DATABASE_IMAGE:$CI_COMMIT_SHA"
    - echo "生产环境部署完成"
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
